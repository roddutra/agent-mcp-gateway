name: Publish to MCP Registry

on:
  workflow_run:
    workflows: ["Publish to PyPI"]
    types:
      - completed

permissions:
  id-token: write
  contents: read

jobs:
  mcp-registry:
    name: Publish to MCP Registry
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install MCP Publisher
        run: |
          curl -L "https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_$(uname -s | tr '[:upper:]' '[:lower:]')_$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/').tar.gz" | tar xz mcp-publisher
          chmod +x mcp-publisher

      - name: Login to MCP Registry
        run: ./mcp-publisher login github-oidc

      - name: Wait for PyPI propagation
        run: |
          echo "Waiting for PyPI package to propagate..."
          for i in {1..12}; do
            if curl -s -f "https://pypi.org/pypi/agent-mcp-gateway/json" > /dev/null 2>&1; then
              echo "✅ PyPI package is available"
              exit 0
            fi
            echo "⏳ Attempt $i/12: Package not yet available, waiting 30s..."
            sleep 30
          done
          echo "⚠️ Package not detected after 6 minutes, proceeding anyway..."

      - name: Publish to MCP Registry
        run: ./mcp-publisher publish

      - name: Report status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "✅ Successfully published to MCP Registry"
            echo "Server: io.github.roddutra/agent-mcp-gateway"
            echo "Verify at: https://registry.mcp.io/api/servers/io.github.roddutra/agent-mcp-gateway"
          else
            echo "❌ Failed to publish to MCP Registry"
            echo "Check workflow logs for details"
          fi
